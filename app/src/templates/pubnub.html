<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BT Beacons via PubNub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.2/css/foundation.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.2/js/foundation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.2/js/vendor/jquery.min.js"></script>
</head>
<body>

<div class="grid-container">
    <h2>Beacon Scanner: <span id="status">Initializing</span></h2>
    <p id="category"></p>

    <h3>Messages</h3>
    <button id="toggle" onclick="toggleUpdate()" type="button" class="success button">Pause</button>

    <div class="grid-x grid-margin-x" id="messages" data-sub-key="{{ sub_key }}">
        <div id="raw_channel_ctr" class="cell auto">
            <h5>raw_channel</h5>
            <div id="raw_channel" style="height: 450px; overflow-y: scroll;"></div>
        </div>
        <div id="ranged_ctr" class="cell auto">
            <h5>ranged</h5>
            <div id="ranged" style="height: 450px; overflow-y: scroll;"></div>
        </div>
        <div id="located_ctr" class="cell auto">
            <h5>located</h5>
            <div id="located" style="height: 450px; overflow-y: scroll;"></div>
        </div>
        <div id="nodes_ctr" class="cell auto">
            <h5>nodes</h5>
            <div id="nodes" style="height: 450px; overflow-y: scroll;"></div>
        </div>
    </div>
</div>


<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.20.3.js"></script>
<script>
    const messages = document.getElementById("messages");
    const sub_key = messages.getAttribute("data-sub-key");
    let update = true;

    let pubnub = new PubNub({
        subscribeKey: sub_key,
        ssl: true
    });

    function scrollToBottom(divId) {
        let element = document.getElementById(divId);
        element.scrollTop = element.scrollHeight;
    }

    function toggleUpdate() {
        update = !update;
        if (update) {
            document.getElementById("toggle").innerText = "Pause"
        } else {
            document.getElementById("toggle").innerText = "Play"
        }
    }

    window.onload = function () {
        document.getElementById("status").innerHTML = "Creating Listener...";

        pubnub.addListener({
            message: function (m) {
                let channelName = m.channel; // The channel for which the message belongs
                let channelGroup = m.subscription; // The channel group or wildcard subscription match (if exists)
                let pubTT = m.timetoken; // Publish timetoken
                let msg = m.message; // The Payload

                if (update) {
                    let new_msg = document.createElement("p");
                    new_msg.style.cssText = 'color: #777; font-size: 0.7em;';
                    if (msg !== null && typeof msg === 'object') {
                        msg = JSON.stringify(msg)
                    }
                    new_msg.innerText = msg;
                    let msg_element = document.getElementById(channelName);
                    msg_element.appendChild(new_msg);

                    // Doesn't allow for scrolling up at all
                    let shouldScroll = msg_element.scrollHeight + msg_element.scrollTop >= msg_element.clientHeight;
                    if (shouldScroll) {
                        scrollToBottom(channelName);
                    }
                }
            },
            status: function (s) {
                let affectedChannelGroups = s.affectedChannelGroups;
                let affectedChannels = s.affectedChannels;
                let category = s.category;
                let operation = s.operation;
                document.getElementById("category").innerHTML = category;
            }
        });

        document.getElementById("status").innerHTML = "Subscribing...";

        pubnub.subscribe({
            channels: ['nodes', 'raw_channel', 'ranged', 'located'],
        });

        document.getElementById("status").innerHTML = "Subscribed";
    }
</script>

</body>
</html>